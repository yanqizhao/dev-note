# iOS开发中的协议

这周想说说iOS开发中协议的使用。

## 协议

首先说协议，在最开始接触iOS开发的时候，对协议与代理的理解是：一个类可以声明一个协议，在协议中有若干方法，然后这个类的实例可以设置一个代理，让代理去实现这些协议中的方法，这样可以解耦，减少类之间的依赖。

一直以来我对协议的理解都停留在这个层面上，直到最近在做组件化的过程中，我负责写一些底层通用模块的时候对协议的用法有了新的理解。

当你设计一个底层通用模块时，往往会存在这样一种情况，你会写一个基类来实现一部分功能，但不希望上层通过继承的方式来扩展方法，这时就可以写一个通用的协议，由上层来遵循并实现，记得之前听过的一个直播里就讲过这样的方式，当你想要扩展的方法是一些动作与行为的时候，就最好使用协议，而扩展的方法为静止的一些模型与功能时，再考虑使用继承，这里就印证了这一点。

**高能插播，这是后记，总结来说就是：以前我认为，协议是我想做一件事情，但是懒，所以找个代理帮我去做，我给他点好处就行了。现在我发现，是你想求我办事，可我是这么随便的人么，所以我得定个规矩，不按我套路出牌的人都拜拜。**

举个例子来讲，最近我在写底层的数据上报模块，我们使用的上报平台包括友盟，MTA和我们自己的数据平台，以及后来又接入的实时上报接口的平台。也就是说我们把数据上报到了四个不同的平台，然而，并不是每条都会全部使用这四个平台，大多数可以只用前三个，有些接口的只用MTA与自己的数据平台，而接口错误的上报却会上报到MTA与实时上报平台，就是说会有多种组合的情况。上报还分为实时与延时，也就是说上报策略还会有不同的选择。

写到这里突然想起之前去听饿了么讲座的时候，他们讲的APM，就是Application Performance Management(应用性能管理)，记得当时他们说正在研发实现埋点自动上报的功能，届时就不需要开发人员去手写代码了，这与MTA现有的可视化埋点应该是类似的。希望不久的将来，我们可以把更多的时间用到优化应用的性能与体验上，不再需要用代码跟数据上报打交道了。

继续来讲我们的底层数据上报模块，因为工程中内置了两个必备的平台：友盟与MTA，这里我们通过枚举的方式将其内置于该模块中，而其他希望由上层扩展的模块则通过协议来扩展，为了能够区分开各个平台，在协议中添加了必选的唯一标识identifier的getter方法，这样每扩展出一个平台的时候都需要提供其唯一标识。

在应用启动时我们会为每个内置好的平台传入相应的配置，如友盟与MTA的app key，而扩展出的平台又该如何区分呢，这里我们会通过传入平台实例的方式来区分。因为对于我的底层上报管理类来讲，代理的个数就是想要接入的数据平台的个数，这里就不能简单的设置某个类的实例为当前类的代理了，而应该通过各平台的唯一标识来将其加入我的代理队列里，并且为了能够区分各平台，不能简单的使用数组而应该使用键值对，key为平台的identifier，value为平台的实例对象，这里说到实例对象，我就想到一个问题，在协议中的方法是否都只能是实例方法而不能是类方法呢，我的想法是：是。因为我在使用代理的时候需要将某个遵循我协议的类的实例设置为我的代理，而不能将这个类设置为我的代理，这样也就不能存在协议中的类方法了。(哈哈，这里又打脸了(￣ε(#￣)☆╰╮(￣▽￣///))

最后，也就是通过各平台的identifier来找到我需要上报的平台并实现真正的上报了，这里我们设计了两个方法，如果需要向当前注册过的所有的平台上报数据时可以直接上报，而如果需要上报个别平台时，可以通过传入平台identifier作为参数来上报。

